[{"id":"7f3219f0beb025c3","type":"tab","label":"BIL54 api.statbank.dk","disabled":false,"info":"","env":[]},{"id":"36a828017042c198","type":"tab","label":"AREALDK api.statbank.dk","disabled":false,"info":"# Danmarks areal\n### Statistikken viser Danmarks areal fordelt efter kommuner og regioner, opgjort pr. 1. januar. \nFra 2011 er opgørelsen baseret på data fra Geodatastyrelsens matrikelregister.\nKun matrikulerede områder er medtaget ved opmålingen, hvilket medfører, at mange søer ikke er medtaget. '\nFor kommuner med umatrikulerede søer vil arealet derfor være faldet sammenlignet med tidligere. Pr. 1. januar 2011-2013 gælder yderligere for København og Frederiksberg, at vejene ikke er matrikuleret og derfor ikke indgår i det opmålte areal.\n\nhttps://www.dst.dk/da/Statistik/dokumentation/statistikdokumentation/arealregnskab/indhold","env":[]},{"id":"8b14b3c953574b40","type":"tab","label":"FORBRUG energidataservice.dk","disabled":false,"info":"# FORBRUG\n\n[Energidataservice](https://www.energidataservice.dk/tso-electricity/ConsumptionpermunicipalityDE35)","env":[]},{"id":"8571dcc8e1e9c903","type":"tab","label":"PRODUKTION energidataservice.dk","disabled":false,"info":"\nhttps://www.energidataservice.dk/tso-electricity/CommunityProduction","env":[]},{"id":"5f815c7f5707ec58","type":"subflow","name":"Database connector","info":"","category":"","in":[{"x":80,"y":100,"wires":[{"id":"aee5892dbbe3d82b"}]}],"out":[{"x":930,"y":100,"wires":[{"id":"b7fbaea9143be3f1","port":0}]}],"env":[],"meta":{},"color":"#3FADB5","inputLabels":["Query input"],"outputLabels":["Result output"],"icon":"node-red/db.svg"},{"id":"e927759a0e35212b","type":"group","z":"8b14b3c953574b40","name":"Udregn startdato for datatræk","style":{"label":true,"stroke":"none","fill":"#dbcbe7","fill-opacity":"0.39"},"nodes":["74d1dfee25742878","3dbcb455c679d5cd","b8b69a38c0aedf34","72ee09fd25a880d5","921fba1309b4cc59"],"x":114,"y":239,"w":1152,"h":166},{"id":"8373144d65750968","type":"group","z":"8b14b3c953574b40","name":"Forespørgsel til api.energidataservice.dk","style":{"label":true,"stroke":"none","fill":"#e3f3d3","fill-opacity":"0.5","color":"#7f7f7f"},"nodes":["65e7437a46c33c4d","5a0352bb0b5135ef","823f81c0457b06db","ead0a5539c5bb1b9"],"x":114,"y":434,"w":852,"h":119},{"id":"0ec48b0df0503cd8","type":"group","z":"8b14b3c953574b40","name":"Datavask og filtrering","style":{"stroke":"none","stroke-opacity":"0.5","label":true,"fill":"#ffefbf","fill-opacity":"0.49"},"nodes":["9e80d7b912c64137","1a4e1900ef39aeb2"],"x":114,"y":567,"w":392,"h":106},{"id":"558021ee7e67a81d","type":"group","z":"8b14b3c953574b40","name":"Skrivning af data til database","style":{"label":true,"stroke":"none","fill":"#ffefbf","fill-opacity":"0.5"},"nodes":["6440c7c789cb52fe","ea6b9ddd404c6bfa","69dbd2a0eb7ccecd","8325eda0730fbb71"],"x":114,"y":695,"w":592,"h":130},{"id":"7c7a1adb80186cae","type":"group","z":"36a828017042c198","name":"Initialisering af tabelnavn og database","style":{"stroke":"none","fill":"#bfdbef","label":true,"color":"#7f7f7f","fill-opacity":"0.5"},"nodes":["c2a7d80a8df9fc53","2d9e69a26787f421","7f3fa659dc7e3a5c"],"x":614,"y":55,"w":712,"h":130},{"id":"94f2534250740b77","type":"group","z":"36a828017042c198","name":"Skrivning af data til database","style":{"label":true,"stroke":"none","fill":"#ffefbf","fill-opacity":"0.5"},"nodes":["077bfbcc6043bdb1","8517e1ef1f306cd4","daa7a7e364322fd6","1684e0f47b1b54d1"],"x":114,"y":575,"w":642,"h":130},{"id":"7b1390c441209648","type":"group","z":"36a828017042c198","name":"Datavask og filtrering","style":{"stroke":"none","stroke-opacity":"0.5","label":true,"fill":"#ffefbf","fill-opacity":"0.49"},"nodes":["90b5f43d586b5bfe","485a43a04e99f6b3","5476474f50f31f4e","a2685221cb05fc5a"],"x":114,"y":414,"w":952,"h":119},{"id":"7fe3437fd75f09f8","type":"group","z":"7f3219f0beb025c3","name":"Skrivning af data til database","style":{"label":true,"stroke":"none","fill":"#ffefbf","fill-opacity":"0.5"},"nodes":["aa4085ae631b7f7f","9eb71b7a3795cc96","2e9339b2c18a23f4","b066f894d60d04da"],"x":114,"y":575,"w":652,"h":130},{"id":"68638907faf95219","type":"group","z":"7f3219f0beb025c3","name":"Datavask og filtrering","style":{"stroke":"none","stroke-opacity":"0.5","label":true,"fill":"#ffefbf","fill-opacity":"0.49"},"nodes":["882797cfacc7ff7c","6cef18fad00d03a7","54bea232f93f8f0b","4b86f589fd76f9d5"],"x":114,"y":414,"w":832,"h":119},{"id":"992b69685929fd28","type":"group","z":"36a828017042c198","name":"Forespørgsel til api.statbank.dk","style":{"label":true,"stroke":"none","fill":"#e3f3d3","fill-opacity":"0.5","color":"#7f7f7f"},"nodes":["46868fe38cf5a184","bbcb5f39dd352e01","a23d55dbf287fcfa"],"x":114,"y":255,"w":952,"h":130},{"id":"551ed5c8ce0f31c7","type":"group","z":"7f3219f0beb025c3","name":"Forespørgsel til api.statbank.dk","style":{"label":true,"stroke":"none","fill":"#e3f3d3","fill-opacity":"0.5","color":"#7f7f7f"},"nodes":["4570c6c9a34474fa","2572a9725c8bd282","3302debcb6e0a7d8"],"x":114,"y":255,"w":952,"h":130},{"id":"0b6a3796775ca5e9","type":"group","z":"8571dcc8e1e9c903","name":"Udregn startdato for datatræk","style":{"label":true,"stroke":"none","fill":"#dbcbe7","fill-opacity":"0.39"},"nodes":["cabaa0127db8b20a","4cfca818d34a77d6","aec106ee16324493","627b9982c16502f9","8899c8d86911d51f"],"x":114,"y":239,"w":1152,"h":166},{"id":"aba12498e68c82c2","type":"group","z":"8571dcc8e1e9c903","name":"Forespørgsel til api.energidataservice.dk","style":{"label":true,"stroke":"none","fill":"#e3f3d3","fill-opacity":"0.5","color":"#7f7f7f"},"nodes":["1ae4294ce24de36c","f934320bfabf4b28","ba6de20626a2f922","12af887fa3e97f37"],"x":114,"y":434,"w":852,"h":119},{"id":"c48edeb2197fb965","type":"group","z":"8571dcc8e1e9c903","name":"Datavask og filtrering","style":{"stroke":"none","stroke-opacity":"0.5","label":true,"fill":"#ffefbf","fill-opacity":"0.49"},"nodes":["bae7dd126b39e4a3","9b3dab7dd179293a"],"x":114,"y":567,"w":492,"h":106},{"id":"61c8622d890b37d9","type":"group","z":"8571dcc8e1e9c903","name":"Skrivning af data til database","style":{"label":true,"stroke":"none","fill":"#ffefbf","fill-opacity":"0.5"},"nodes":["85f69593f6d7665e","37c93df8cc9511ca","273cf4f3b5ad8b9d","b876a7ae4aa0d502"],"x":114,"y":695,"w":582,"h":130},{"id":"775f1511bb6470f8","type":"group","z":"5f815c7f5707ec58","name":"Database connector","style":{"stroke":"none","stroke-opacity":"0.5","fill":"#bfc7d7","fill-opacity":"0.51","label":true,"color":"#3f3f3f"},"nodes":["aee5892dbbe3d82b","c67629cbfb8b8373","321ce2c6e7eb1091","5da16564b7f0f0c1","b7fbaea9143be3f1"],"x":194,"y":19},{"id":"420f87762af87ac6","type":"group","z":"36a828017042c198","name":"Triggers","style":{"stroke":"none","fill":"#dbcbe7","fill-opacity":"0.51","label":true},"nodes":["49a382e63c795f8b","9c5256e50882b0af","7a9038c6f798cfa3","eca4a640b3925439"],"x":114,"y":47,"w":492,"h":154},{"id":"62d1b4969e322491","type":"group","z":"7f3219f0beb025c3","name":"Initialisering af tabelnavn og database","style":{"stroke":"none","fill":"#bfdbef","label":true,"color":"#7f7f7f","fill-opacity":"0.5"},"nodes":["85b6b60428bd1e4c","f4071b3393682d2e","3e67a5def24cc8e4"],"x":614,"y":55,"w":712,"h":130},{"id":"dce8b91a0662f793","type":"group","z":"7f3219f0beb025c3","name":"Triggers","style":{"stroke":"none","fill":"#dbcbe7","fill-opacity":"0.51","label":true},"nodes":["3a2c20021c59c43c","d70c9a3e0a47a186","7278d8a019646c2b","3af44629275ce741"],"x":114,"y":47,"w":492,"h":154},{"id":"d7a0dc9f17f84cd2","type":"group","z":"8b14b3c953574b40","name":"Initialisering af tabelnavn og database","style":{"stroke":"none","fill":"#bfdbef","label":true,"color":"#7f7f7f","fill-opacity":"0.5"},"nodes":["43d0cf92514303e7","6ce841fbce39163d","1582f6ecc6731fd7"],"x":614,"y":55,"w":712,"h":130},{"id":"ca8ecf0bcc98d479","type":"group","z":"8b14b3c953574b40","name":"Triggers","style":{"stroke":"none","fill":"#dbcbe7","fill-opacity":"0.51","label":true},"nodes":["dee8b7623e6d0ddd","03cb13cd415ca430","7e95b253cad342a4","45577688ac957f99"],"x":114,"y":47,"w":492,"h":154},{"id":"6aa95c95913a1dc8","type":"group","z":"8571dcc8e1e9c903","name":"Initialisering af tabelnavn og database","style":{"stroke":"none","fill":"#bfdbef","label":true,"color":"#7f7f7f","fill-opacity":"0.5"},"nodes":["4be122699e16f822","8f35b8f426ac7542","5b1c780ffe35c1eb"],"x":614,"y":55,"w":712,"h":130},{"id":"616fd052c81e52cc","type":"group","z":"8571dcc8e1e9c903","name":"Triggers","style":{"stroke":"none","fill":"#dbcbe7","fill-opacity":"0.51","label":true},"nodes":["5c265e4ca4ab11ea","1e0bb0ba8b707c57","59b47841deed3db1","ac5e094c99a67b2d"],"x":114,"y":47,"w":492,"h":154},{"id":"fcaad244b4f1f00c","type":"junction","z":"8b14b3c953574b40","x":80,"y":580,"wires":[["1a4e1900ef39aeb2"]]},{"id":"5677ad908821d1ec","type":"junction","z":"8b14b3c953574b40","x":80,"y":700,"wires":[["6440c7c789cb52fe"]]},{"id":"5144e4be8fd69dbf","type":"junction","z":"8b14b3c953574b40","x":600,"y":660,"wires":[["5677ad908821d1ec"]]},{"id":"c606d977ccc17344","type":"junction","z":"8b14b3c953574b40","x":980,"y":540,"wires":[["fcaad244b4f1f00c"]]},{"id":"f2715c7e9e262cd3","type":"junction","z":"8b14b3c953574b40","x":80,"y":240,"wires":[["74d1dfee25742878"]]},{"id":"ead0a5539c5bb1b9","type":"junction","z":"8b14b3c953574b40","g":"8373144d65750968","x":700,"y":460,"wires":[["77b93de03ab58823"]]},{"id":"e330064ce7a79cc8","type":"junction","z":"8b14b3c953574b40","x":1320,"y":400,"wires":[["a02c4fae11dcffba"]]},{"id":"a02c4fae11dcffba","type":"junction","z":"8b14b3c953574b40","x":80,"y":440,"wires":[["65e7437a46c33c4d"]]},{"id":"cc9b98b49a6db610","type":"junction","z":"36a828017042c198","x":100,"y":580,"wires":[["daa7a7e364322fd6"]]},{"id":"28f5a6dc5f375384","type":"junction","z":"36a828017042c198","x":80,"y":260,"wires":[["46868fe38cf5a184"]]},{"id":"522e1207706ea814","type":"junction","z":"36a828017042c198","x":80,"y":420,"wires":[["90b5f43d586b5bfe"]]},{"id":"02c42f1bea2e8afc","type":"junction","z":"36a828017042c198","x":1100,"y":380,"wires":[["522e1207706ea814"]]},{"id":"8ad4b29a3e40eee8","type":"junction","z":"36a828017042c198","x":1100,"y":540,"wires":[["cc9b98b49a6db610"]]},{"id":"dd87d22120b64e28","type":"junction","z":"7f3219f0beb025c3","x":80,"y":580,"wires":[["2e9339b2c18a23f4"]]},{"id":"7759da22b51a03e5","type":"junction","z":"7f3219f0beb025c3","x":80,"y":260,"wires":[["3302debcb6e0a7d8"]]},{"id":"73774a24e7a533ac","type":"junction","z":"7f3219f0beb025c3","x":80,"y":420,"wires":[["882797cfacc7ff7c"]]},{"id":"bef728771c500c07","type":"junction","z":"7f3219f0beb025c3","x":1120,"y":380,"wires":[["73774a24e7a533ac"]]},{"id":"ee650a883692de95","type":"junction","z":"7f3219f0beb025c3","x":980,"y":520,"wires":[["dd87d22120b64e28"]]},{"id":"a2685221cb05fc5a","type":"junction","z":"36a828017042c198","g":"7b1390c441209648","x":460,"y":440,"wires":[["8625b2fab96ba8e9"]]},{"id":"4b86f589fd76f9d5","type":"junction","z":"7f3219f0beb025c3","g":"68638907faf95219","x":480,"y":440,"wires":[["0e0f9df272dc5fc1"]]},{"id":"67293dd84e1b0b5c","type":"junction","z":"8571dcc8e1e9c903","x":80,"y":580,"wires":[["9b3dab7dd179293a"]]},{"id":"8da9a91194f7af91","type":"junction","z":"8571dcc8e1e9c903","x":80,"y":700,"wires":[["85f69593f6d7665e"]]},{"id":"fc9b6e0147d4efe1","type":"junction","z":"8571dcc8e1e9c903","x":600,"y":660,"wires":[["8da9a91194f7af91"]]},{"id":"6a2a56ca0f18b384","type":"junction","z":"8571dcc8e1e9c903","x":980,"y":540,"wires":[["67293dd84e1b0b5c"]]},{"id":"cc489fac9fece954","type":"junction","z":"8571dcc8e1e9c903","x":80,"y":240,"wires":[["cabaa0127db8b20a"]]},{"id":"698ef7d845c45259","type":"junction","z":"8571dcc8e1e9c903","x":1320,"y":400,"wires":[["fb7d930fcfb35801"]]},{"id":"fb7d930fcfb35801","type":"junction","z":"8571dcc8e1e9c903","x":80,"y":440,"wires":[["1ae4294ce24de36c"]]},{"id":"12af887fa3e97f37","type":"junction","z":"8571dcc8e1e9c903","g":"aba12498e68c82c2","x":700,"y":460,"wires":[["b747aa1f23624263"]]},{"id":"763d8eba5c8a6e8f","type":"junction","z":"36a828017042c198","x":1380,"y":220,"wires":[["28f5a6dc5f375384"]]},{"id":"eca4a640b3925439","type":"junction","z":"36a828017042c198","g":"420f87762af87ac6","x":580,"y":160,"wires":[["c2a7d80a8df9fc53"]]},{"id":"3af44629275ce741","type":"junction","z":"7f3219f0beb025c3","g":"dce8b91a0662f793","x":580,"y":160,"wires":[["85b6b60428bd1e4c"]]},{"id":"f332853c388a1c3d","type":"junction","z":"7f3219f0beb025c3","x":1360,"y":220,"wires":[["7759da22b51a03e5"]]},{"id":"e5d65cb5d9556f7b","type":"junction","z":"8b14b3c953574b40","x":1380,"y":200,"wires":[["f2715c7e9e262cd3"]]},{"id":"45577688ac957f99","type":"junction","z":"8b14b3c953574b40","g":"ca8ecf0bcc98d479","x":580,"y":160,"wires":[["6ce841fbce39163d"]]},{"id":"ec2cbaa5abdb2dc0","type":"junction","z":"8571dcc8e1e9c903","x":1360,"y":200,"wires":[["cc489fac9fece954"]]},{"id":"ac5e094c99a67b2d","type":"junction","z":"8571dcc8e1e9c903","g":"616fd052c81e52cc","x":580,"y":160,"wires":[["8f35b8f426ac7542"]]},{"id":"5c13e4731fd7f4cf","type":"tls-config","name":"","cert":"","key":"","ca":"","certname":"","keyname":"","caname":"","servername":"","verifyservercert":true,"alpnprotocol":""},{"id":"8dd94efcd0784de3","type":"MySQL-Server-Connector","name":"DB","host":"${DB_HOST}","port":"3306","user":"${DB_USER}","password":"${DB_PASS}","tls":false,"database":"${DB_DATABASE}"},{"id":"aee5892dbbe3d82b","type":"MySQL-Connector","z":"5f815c7f5707ec58","g":"775f1511bb6470f8","server":"8dd94efcd0784de3","name":"Send forespørgsel","x":310,"y":100,"wires":[["321ce2c6e7eb1091","5da16564b7f0f0c1"]]},{"id":"c67629cbfb8b8373","type":"debug","z":"5f815c7f5707ec58","g":"775f1511bb6470f8","name":"debug 27","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":700,"y":60,"wires":[]},{"id":"321ce2c6e7eb1091","type":"json","z":"5f815c7f5707ec58","g":"775f1511bb6470f8","name":"","property":"payload","action":"","pretty":false,"x":530,"y":60,"wires":[["c67629cbfb8b8373"]]},{"id":"5da16564b7f0f0c1","type":"change","z":"5f815c7f5707ec58","g":"775f1511bb6470f8","name":"fjern query","rules":[{"t":"delete","p":"topic","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":550,"y":100,"wires":[["b7fbaea9143be3f1"]]},{"id":"b7fbaea9143be3f1","type":"json","z":"5f815c7f5707ec58","g":"775f1511bb6470f8","name":"","property":"payload","action":"obj","pretty":false,"x":710,"y":100,"wires":[[]]},{"id":"aa4085ae631b7f7f","type":"delay","z":"7f3219f0beb025c3","g":"7fe3437fd75f09f8","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"650","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":395,"y":640,"wires":[["b066f894d60d04da"]],"l":false},{"id":"9eb71b7a3795cc96","type":"join","z":"7f3219f0beb025c3","g":"7fe3437fd75f09f8","name":"","mode":"auto","build":"object","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":true,"timeout":"","count":"","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":725,"y":640,"wires":[["2123bf14edf858cc"]],"l":false},{"id":"882797cfacc7ff7c","type":"csv","z":"7f3219f0beb025c3","g":"68638907faf95219","name":"Konverter data ↓ \\n Fra semikolon separeret tekst til JSON","sep":";","hdrin":true,"hdrout":"none","multi":"one","ret":"\\n","temp":"","skip":"0","strings":true,"include_empty_strings":"","include_null_values":"","x":290,"y":480,"wires":[["6cef18fad00d03a7","4b86f589fd76f9d5"]]},{"id":"6cef18fad00d03a7","type":"change","z":"7f3219f0beb025c3","g":"68638907faf95219","name":"Fjern overflødige \\n datafelter","rules":[{"t":"delete","p":"payload.OMRÅDE","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":570,"y":480,"wires":[["54bea232f93f8f0b"]]},{"id":"54bea232f93f8f0b","type":"change","z":"7f3219f0beb025c3","g":"68638907faf95219","name":"Rens og oversæt datofelt \\n til iso8601","rules":[{"t":"move","p":"payload","pt":"msg","to":"data","tot":"msg"},{"t":"set","p":"data.maaned","pt":"msg","to":"$map(data.TID, function($v, $i, $a) {    $replace($substring($v,8),\"M\",\"-\") & \"-01\" })","tot":"jsonata"},{"t":"delete","p":"data.TID","pt":"msg"},{"t":"delete","p":"payload","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":810,"y":480,"wires":[["ee650a883692de95"]]},{"id":"2e9339b2c18a23f4","type":"template","z":"7f3219f0beb025c3","g":"7fe3437fd75f09f8","name":"Forespørgsel ↓\\n Indsæt eller opdater \\n data i tabel","field":"topic","fieldType":"msg","format":"sql","syntax":"mustache","template":"INSERT INTO {{flow.tablename}} \n    (Måned, Biltype, Drivmiddel, Anvendelse, Antal)\nVALUES( \n        '{{{data.maaned}}}',\n        '{{{data.BILTYPE}}}',\n        '{{{data.DRIV}}}',\n        '{{{data.BRUG}}}',\n        '{{{data.INDHOLD}}}'\n        )\nON DUPLICATE KEY UPDATE\n    Antal = '{{{data.INDHOLD}}}'","output":"str","x":240,"y":640,"wires":[["aa4085ae631b7f7f"]]},{"id":"0e0f9df272dc5fc1","type":"join","z":"7f3219f0beb025c3","name":"","mode":"auto","build":"object","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":true,"timeout":"","count":"","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":975,"y":440,"wires":[["c5d4ecc27825ec66"]],"l":false},{"id":"4570c6c9a34474fa","type":"change","z":"7f3219f0beb025c3","g":"551ed5c8ce0f31c7","name":"Oprydning i uaktuelle parametre","rules":[{"t":"delete","p":"headers","pt":"msg"},{"t":"delete","p":"cronplus","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":910,"y":320,"wires":[["bef728771c500c07"]]},{"id":"2572a9725c8bd282","type":"http request","z":"7f3219f0beb025c3","g":"551ed5c8ce0f31c7","name":"Send forespørgsel","method":"use","ret":"txt","paytoqs":"ignore","url":"","tls":"5c13e4731fd7f4cf","persist":false,"proxy":"","insecureHTTPParser":false,"authType":"","senderr":false,"headers":[],"x":650,"y":320,"wires":[["4570c6c9a34474fa"]]},{"id":"3302debcb6e0a7d8","type":"change","z":"7f3219f0beb025c3","g":"551ed5c8ce0f31c7","name":"Opsætning af forespørgsel ↓ \\n Totalt antal indregistrerede biler i Randers Kommune \\n pr. måned, biltype, anvendelse og drivmiddel. ","rules":[{"t":"set","p":"url","pt":"msg","to":"https://api.statbank.dk/v1/data","tot":"str"},{"t":"set","p":"method","pt":"msg","to":"POST","tot":"str"},{"t":"set","p":"payload","pt":"msg","to":"{\"table\":\"BIL54\",\"format\":\"CSV\",\"valuePresentation\":\"CodeAndValue\",\"variables\":[{\"code\":\"OMRÅDE\",\"values\":[\"730\"]},{\"code\":\"BILTYPE\",\"values\":[\"4000101002\",\"4000102000\"]},{\"code\":\"BRUG\",\"values\":[\"1100\",\"1200\"]},{\"code\":\"DRIV\",\"values\":[\"20205\",\"20210\",\"20215\",\"20220\",\"20225\",\"20230\",\"20231\",\"20232\",\"20235\"]},{\"code\":\"Tid\",\"values\":[\"*\"]}]}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":340,"y":320,"wires":[["2572a9725c8bd282"]]},{"id":"c5d4ecc27825ec66","type":"debug","z":"7f3219f0beb025c3","name":"stdout","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"{\t   \"target-table\" : $flowContext(\"tablename\"),\t   \"endpoint\" : url,\t   \"http-response-code\" : statusCode,\t   \"status\" : \"datapull complete\",\t   \"returned-rows\" : $count(payload)\t}","targetType":"jsonata","statusVal":"","statusType":"auto","x":1080,"y":440,"wires":[]},{"id":"2123bf14edf858cc","type":"debug","z":"7f3219f0beb025c3","name":"stdout","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"{\t   $flowContext(\"tablename\") : \"data insert complete\",\t   \"inserted-rows\" : $count(payload)\t}","targetType":"jsonata","statusVal":"","statusType":"auto","x":860,"y":640,"wires":[]},{"id":"3e67a5def24cc8e4","type":"template","z":"7f3219f0beb025c3","g":"62d1b4969e322491","name":"Forespørgsel ↓\\n Opret tabel hvis der ikke \\n eksisterer en i forvejen ","field":"topic","fieldType":"msg","format":"sql","syntax":"mustache","template":"CREATE TABLE if not exists {{flow.tablename}} (\n\tcreated TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\n\tlast_updated TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n\tMåned DATE,\n\tBiltype varchar(256),\n\tDrivmiddel varchar(48),\n\tAnvendelse varchar(128),\n\tAntal INT,\n\tUNIQUE (Måned, Drivmiddel, Biltype, Anvendelse)\n\t);","output":"str","x":990,"y":120,"wires":[["f4071b3393682d2e"]]},{"id":"4057cf82e6442f23","type":"debug","z":"7f3219f0beb025c3","name":"stdout","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"payload.warningStatus = 0\t? { $flowContext(\"tablename\"): \"table created\" }:\tpayload.warningStatus = 1\t? { $flowContext(\"tablename\"): \"table exists\" }:\t{\"warningstatus\" : payload.warningStatus}","targetType":"jsonata","statusVal":"","statusType":"auto","x":1420,"y":120,"wires":[]},{"id":"85b6b60428bd1e4c","type":"change","z":"7f3219f0beb025c3","g":"62d1b4969e322491","name":"Konfigurer tabelnavn","rules":[{"t":"set","p":"tablename","pt":"flow","to":"dst_BIL54","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":740,"y":120,"wires":[["3e67a5def24cc8e4"]]},{"id":"f4071b3393682d2e","type":"subflow:5f815c7f5707ec58","z":"7f3219f0beb025c3","g":"62d1b4969e322491","name":"Send forespørgsel \\n til database","x":1210,"y":120,"wires":[["4057cf82e6442f23","f332853c388a1c3d"]]},{"id":"3a2c20021c59c43c","type":"cronplus","z":"7f3219f0beb025c3","g":"dce8b91a0662f793","name":"Scheduled run","outputField":"payload","timeZone":"","persistDynamic":false,"commandResponseMsgOutput":"output1","outputs":1,"options":[{"name":"schedule1","topic":"topic1","payloadType":"default","payload":"","expressionType":"cron","expression":"0  0  1  1  *  ","location":"","offset":"0","solarType":"all","solarEvents":"sunrise,sunset"}],"x":240,"y":160,"wires":[["3af44629275ce741"]]},{"id":"d70c9a3e0a47a186","type":"inject","z":"7f3219f0beb025c3","g":"dce8b91a0662f793","name":"Kør een gang \\n efter hvert nyt deploy","props":[],"repeat":"","crontab":"","once":true,"onceDelay":"7","topic":"","x":260,"y":100,"wires":[["7278d8a019646c2b"]]},{"id":"7278d8a019646c2b","type":"switch","z":"7f3219f0beb025c3","g":"dce8b91a0662f793","name":"Tjek om der køres \\n i udviklermiljø","property":"DEV_ENVIROMENT","propertyType":"env","rules":[{"t":"eq","v":"false","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":490,"y":100,"wires":[["85b6b60428bd1e4c"]]},{"id":"b066f894d60d04da","type":"subflow:5f815c7f5707ec58","z":"7f3219f0beb025c3","g":"7fe3437fd75f09f8","name":"Send forespørgsel \\n til database","x":550,"y":640,"wires":[["9eb71b7a3795cc96"]]},{"id":"49a382e63c795f8b","type":"cronplus","z":"36a828017042c198","g":"420f87762af87ac6","name":"Scheduled run","outputField":"payload","timeZone":"","persistDynamic":false,"commandResponseMsgOutput":"output1","outputs":1,"options":[{"name":"schedule1","topic":"topic1","payloadType":"default","payload":"","expressionType":"cron","expression":"0  0  1  1  *  ","location":"","offset":"0","solarType":"all","solarEvents":"sunrise,sunset"}],"x":240,"y":160,"wires":[["eca4a640b3925439"]]},{"id":"9c5256e50882b0af","type":"inject","z":"36a828017042c198","g":"420f87762af87ac6","name":"Kør een gang \\n efter hvert nyt deploy","props":[],"repeat":"","crontab":"","once":true,"onceDelay":"7","topic":"","x":260,"y":100,"wires":[["7a9038c6f798cfa3"]]},{"id":"c2a7d80a8df9fc53","type":"change","z":"36a828017042c198","g":"7c7a1adb80186cae","name":"Konfigurer tabelnavn","rules":[{"t":"set","p":"tablename","pt":"flow","to":"dst_AREALDK","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":740,"y":120,"wires":[["2d9e69a26787f421"]]},{"id":"2d9e69a26787f421","type":"template","z":"36a828017042c198","g":"7c7a1adb80186cae","name":"Forespørgsel ↓\\n Opret tabel hvis der ikke \\n eksisterer en i forvejen ","field":"topic","fieldType":"msg","format":"sql","syntax":"mustache","template":"CREATE TABLE if not exists {{flow.tablename}} (\n\tcreated TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\n\tlast_updated TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n\tMåned DATE,\n\tArealtype varchar(256),\n\tAreal_km2 DECIMAL(4,1),\n\tUNIQUE (Måned, Arealtype)\n\t);","output":"str","x":990,"y":120,"wires":[["7f3fa659dc7e3a5c"]]},{"id":"077bfbcc6043bdb1","type":"delay","z":"36a828017042c198","g":"94f2534250740b77","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"650","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":385,"y":640,"wires":[["1684e0f47b1b54d1"]],"l":false},{"id":"8517e1ef1f306cd4","type":"join","z":"36a828017042c198","g":"94f2534250740b77","name":"","mode":"auto","build":"object","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":true,"timeout":"","count":"","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":715,"y":640,"wires":[["ba90debab3691911"]],"l":false},{"id":"daa7a7e364322fd6","type":"template","z":"36a828017042c198","g":"94f2534250740b77","name":"Forespørgsel ↓\\n Indsæt eller opdater \\n data i tabel","field":"topic","fieldType":"msg","format":"sql","syntax":"mustache","template":"INSERT INTO {{flow.tablename}} \n    (Måned, Arealtype, Areal_km2)\nVALUES( \n        '{{{data.TID}}}',\n        '{{{data.ARE1}}}',\n        '{{{data.INDHOLD}}}'\n        )\nON DUPLICATE KEY UPDATE\n    Areal_km2 = '{{{data.INDHOLD}}}'","output":"str","x":240,"y":640,"wires":[["077bfbcc6043bdb1"]]},{"id":"90b5f43d586b5bfe","type":"csv","z":"36a828017042c198","g":"7b1390c441209648","name":"Konverter data ↓ \\n Fra semikolon separeret tekst til JSON","sep":";","hdrin":true,"hdrout":"none","multi":"one","ret":"\\n","temp":"","skip":"0","strings":true,"include_empty_strings":"","include_null_values":"","x":290,"y":480,"wires":[["485a43a04e99f6b3","a2685221cb05fc5a"]]},{"id":"485a43a04e99f6b3","type":"change","z":"36a828017042c198","g":"7b1390c441209648","name":"Fjern overflødige \\n datafelter","rules":[{"t":"delete","p":"payload.OMRÅDE","pt":"msg"},{"t":"delete","p":"payload.ENHED","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":570,"y":480,"wires":[["5476474f50f31f4e"]]},{"id":"5476474f50f31f4e","type":"change","z":"36a828017042c198","g":"7b1390c441209648","name":"Rens og oversæt datofelt \\n til iso8601 og konverter areal til US decimal","rules":[{"t":"move","p":"payload","pt":"msg","to":"data","tot":"msg"},{"t":"set","p":"data.TID","pt":"msg","to":"data.TID & \"-12-01\"","tot":"jsonata"},{"t":"set","p":"data.INDHOLD","pt":"msg","to":"$number($replace(data.INDHOLD, \",\", \".\"))","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":870,"y":480,"wires":[["8ad4b29a3e40eee8"]]},{"id":"8625b2fab96ba8e9","type":"join","z":"36a828017042c198","name":"","mode":"auto","build":"object","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":true,"timeout":"","count":"","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":1075,"y":440,"wires":[["c6673a134c929996"]],"l":false},{"id":"46868fe38cf5a184","type":"change","z":"36a828017042c198","g":"992b69685929fd28","name":"Opsætning af forespørgsel ↓ \\n Totalt antal kvm2 skov og engarealer \\n i Randers Kommune for alle registrerede år","rules":[{"t":"set","p":"url","pt":"msg","to":"https://api.statbank.dk/v1/data","tot":"str"},{"t":"set","p":"method","pt":"msg","to":"POST","tot":"str"},{"t":"set","p":"payload","pt":"msg","to":"{\"table\":\"AREALDK\",\"format\":\"CSV\",\"variables\":[{\"code\":\"OMRÅDE\",\"values\":[\"730\"]},{\"code\":\"ENHED\",\"values\":[\"0120\"]},{\"code\":\"Tid\",\"values\":[\"*\"]},{\"code\":\"ARE1\",\"values\":[\"E\",\"F2\"]}]}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":310,"y":320,"wires":[["a23d55dbf287fcfa"]]},{"id":"bbcb5f39dd352e01","type":"change","z":"36a828017042c198","g":"992b69685929fd28","name":"Oprydning i uaktuelle parametre","rules":[{"t":"delete","p":"headers","pt":"msg"},{"t":"delete","p":"cronplus","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":910,"y":320,"wires":[["02c42f1bea2e8afc"]]},{"id":"a23d55dbf287fcfa","type":"http request","z":"36a828017042c198","g":"992b69685929fd28","name":"Send forespørgsel","method":"use","ret":"txt","paytoqs":"ignore","url":"","tls":"5c13e4731fd7f4cf","persist":false,"proxy":"","insecureHTTPParser":false,"authType":"","senderr":false,"headers":[],"x":630,"y":320,"wires":[["bbcb5f39dd352e01"]]},{"id":"d31a7e940eaf4733","type":"debug","z":"36a828017042c198","name":"stdout","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"payload.warningStatus = 0\t? { $flowContext(\"tablename\"): \"table created\" }:\tpayload.warningStatus = 1\t? { $flowContext(\"tablename\"): \"table exists\" }:\t{\"warningstatus\" : payload.warningStatus}","targetType":"jsonata","statusVal":"","statusType":"auto","x":1420,"y":120,"wires":[]},{"id":"c6673a134c929996","type":"debug","z":"36a828017042c198","name":"stdout","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"{\t   \"target-table\" : $flowContext(\"tablename\"),\t   \"endpoint\" : url,\t   \"http-response-code\" : statusCode,\t   \"status\" : \"datapull complete\",\t   \"returned-rows\" : $count(payload)\t}","targetType":"jsonata","statusVal":"","statusType":"auto","x":1180,"y":440,"wires":[]},{"id":"ba90debab3691911","type":"debug","z":"36a828017042c198","name":"stdout","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"{\t   $flowContext(\"tablename\") : \"data insert complete\",\t   \"inserted-rows\" : $count(payload)\t}","targetType":"jsonata","statusVal":"","statusType":"auto","x":860,"y":640,"wires":[]},{"id":"7a9038c6f798cfa3","type":"switch","z":"36a828017042c198","g":"420f87762af87ac6","name":"Tjek om der køres \\n i udviklermiljø","property":"DEV_ENVIROMENT","propertyType":"env","rules":[{"t":"eq","v":"false","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":490,"y":100,"wires":[["c2a7d80a8df9fc53"]]},{"id":"7f3fa659dc7e3a5c","type":"subflow:5f815c7f5707ec58","z":"36a828017042c198","g":"7c7a1adb80186cae","name":"Send forespørgsel \\n til database","x":1210,"y":120,"wires":[["d31a7e940eaf4733","763d8eba5c8a6e8f"]]},{"id":"1684e0f47b1b54d1","type":"subflow:5f815c7f5707ec58","z":"36a828017042c198","g":"94f2534250740b77","name":"Send forespørgsel \\n til database","x":530,"y":640,"wires":[["8517e1ef1f306cd4"]]},{"id":"77b93de03ab58823","type":"debug","z":"8b14b3c953574b40","name":"stdout","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"{\t   \"endpoint\" : baseurl,\t   \"http-response-code\" : statusCode,\t   \"status\" : \"datapull complete\",\t   \"returned-rows\" : payload.total\t}","targetType":"jsonata","statusVal":"","statusType":"auto","x":1040,"y":460,"wires":[]},{"id":"74d1dfee25742878","type":"template","z":"8b14b3c953574b40","g":"e927759a0e35212b","name":"Forespørgsel ↓\\n Hent dato for seneste række ","field":"topic","fieldType":"msg","format":"sql","syntax":"mustache","template":"SELECT MAX(Month) as latest_month\nFROM {{flow.tablename}}","output":"str","x":260,"y":320,"wires":[["921fba1309b4cc59"]]},{"id":"3dbcb455c679d5cd","type":"switch","z":"8b14b3c953574b40","g":"e927759a0e35212b","name":"Undersøg dato for \\n seneste række","property":"payload[0].latest_month","propertyType":"msg","rules":[{"t":"null"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":790,"y":320,"wires":[["b8b69a38c0aedf34"],["72ee09fd25a880d5"]]},{"id":"b8b69a38c0aedf34","type":"change","z":"8b14b3c953574b40","g":"e927759a0e35212b","name":"Hvis NULL sæt startdato to 2018","rules":[{"t":"set","p":"startdato","pt":"msg","to":"2018-01-01","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1110,"y":280,"wires":[["e330064ce7a79cc8"]]},{"id":"72ee09fd25a880d5","type":"change","z":"8b14b3c953574b40","g":"e927759a0e35212b","name":"Fjern tidsstempel \\n og sæt startdato til dato-streng \\n for seneste række hentet","rules":[{"t":"set","p":"startdato","pt":"msg","to":"$substring($string(payload[0].latest_month), 1, 10)","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":1110,"y":340,"wires":[["e330064ce7a79cc8"]],"info":"Henter den fulde dato og tid fra den seneste række i databasen, konverterer til en teksstren og fjerner tidsstemplet.\nReturnerer derefter den rensede dato"},{"id":"65e7437a46c33c4d","type":"change","z":"8b14b3c953574b40","g":"8373144d65750968","name":"Opsætning af forespørgsel ↓ \\n Elforbrug total i kwh pr. måned","rules":[{"t":"set","p":"baseurl","pt":"msg","to":"https://api.energidataservice.dk/dataset/ConsumptionpermunicipalityDE35","tot":"str"},{"t":"set","p":"method","pt":"msg","to":"GET","tot":"str"},{"t":"set","p":"url","pt":"msg","to":"baseurl & \"?offset=0&start=\"&startdato&\"&end=now&filter=%7B%22MunicipalityNo%22:[%22730%22]%7D&sort=Month%20DESC&timezone=dk&limit=10000\"","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":500,"wires":[["5a0352bb0b5135ef"]],"info":"Based on url query:\n\nhttps://api.energidataservice.dk/dataset/ConsumptionpermunicipalityDE35?offset=0&start=2013-01-01T00:00&end=2023-03-01T00:00&filter=%7B%22MunicipalityNo%22:[%22730%22]%7D&sort=Month%20DESC&timezone=dk"},{"id":"5a0352bb0b5135ef","type":"http request","z":"8b14b3c953574b40","g":"8373144d65750968","name":"Send forespørgsel","method":"use","ret":"obj","paytoqs":"ignore","url":"","tls":"5c13e4731fd7f4cf","persist":false,"proxy":"","insecureHTTPParser":false,"authType":"","senderr":false,"headers":[],"x":550,"y":500,"wires":[["823f81c0457b06db","ead0a5539c5bb1b9"]]},{"id":"823f81c0457b06db","type":"change","z":"8b14b3c953574b40","g":"8373144d65750968","name":"Oprydning i uaktuelle parametre","rules":[{"t":"delete","p":"url","pt":"msg"},{"t":"delete","p":"method","pt":"msg"},{"t":"delete","p":"headers","pt":"msg"},{"t":"delete","p":"cronplus","pt":"msg"},{"t":"delete","p":"topic","pt":"msg"},{"t":"delete","p":"responseUrl","pt":"msg"},{"t":"delete","p":"manualTrigger","pt":"msg"},{"t":"delete","p":"scheduledEvent","pt":"msg"},{"t":"delete","p":"redirectList","pt":"msg"},{"t":"delete","p":"statusCode","pt":"msg"},{"t":"delete","p":"sort","pt":"msg"},{"t":"delete","p":"object","pt":"msg"},{"t":"set","p":"payload","pt":"msg","to":"payload.records","tot":"msg","dc":true}],"action":"","property":"","from":"","to":"","reg":false,"x":810,"y":500,"wires":[["c606d977ccc17344"]]},{"id":"9e80d7b912c64137","type":"change","z":"8b14b3c953574b40","g":"0ec48b0df0503cd8","name":"Fjern overflødige \\n datafelter","rules":[{"t":"set","p":"data","pt":"msg","to":"{\t   \"Month\" : payload.Month,\t   \"Industrycode_DE35\": payload.Industrycode_DE35,\t   \"TotalConsumption\": payload.TotalCon\t}\t","tot":"jsonata"},{"t":"delete","p":"payload","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":390,"y":620,"wires":[["5144e4be8fd69dbf"]]},{"id":"1a4e1900ef39aeb2","type":"split","z":"8b14b3c953574b40","g":"0ec48b0df0503cd8","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":true,"addname":"","x":190,"y":620,"wires":[["9e80d7b912c64137"]]},{"id":"6440c7c789cb52fe","type":"template","z":"8b14b3c953574b40","g":"558021ee7e67a81d","name":"Forespørgsel ↓\\n Indsæt eller opdater \\n data i tabel","field":"topic","fieldType":"msg","format":"sql","syntax":"mustache","template":"INSERT INTO {{flow.tablename}} \n    (Month,\tIndustrycode_DE35,TotalConsumption)\nVALUES( \n        '{{{data.Month}}}',\n        '{{{data.Industrycode_DE35}}}',\n        '{{data.TotalConsumption}}'\n        )\nON DUPLICATE KEY UPDATE\n    TotalConsumption = '{{data.TotalConsumption}}'","output":"str","x":240,"y":760,"wires":[["ea6b9ddd404c6bfa"]]},{"id":"ea6b9ddd404c6bfa","type":"delay","z":"8b14b3c953574b40","g":"558021ee7e67a81d","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"650","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":375,"y":760,"wires":[["8325eda0730fbb71"]],"l":false},{"id":"69dbd2a0eb7ccecd","type":"join","z":"8b14b3c953574b40","g":"558021ee7e67a81d","name":"","mode":"auto","build":"object","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":true,"timeout":"","count":"","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":665,"y":760,"wires":[["0b66b7189377295c"]],"l":false},{"id":"0b66b7189377295c","type":"debug","z":"8b14b3c953574b40","name":"stdout","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"{\t   $flowContext(\"tablename\") : \"data insert complete\",\t   \"inserted-rows\" : $count(payload)\t}","targetType":"jsonata","statusVal":"","statusType":"auto","x":840,"y":760,"wires":[]},{"id":"5d96150bfa192fe7","type":"debug","z":"8b14b3c953574b40","name":"stdout","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"payload.warningStatus = 0\t? { $flowContext(\"tablename\"): \"table created\" }:\tpayload.warningStatus = 1\t? { $flowContext(\"tablename\"): \"table exists\" }:\t{\"warningstatus\" : payload.warningStatus}","targetType":"jsonata","statusVal":"","statusType":"auto","x":1420,"y":120,"wires":[]},{"id":"43d0cf92514303e7","type":"subflow:5f815c7f5707ec58","z":"8b14b3c953574b40","g":"d7a0dc9f17f84cd2","name":"Send forespørgsel \\n til database","x":1210,"y":120,"wires":[["5d96150bfa192fe7","e5d65cb5d9556f7b"]]},{"id":"dee8b7623e6d0ddd","type":"cronplus","z":"8b14b3c953574b40","g":"ca8ecf0bcc98d479","name":"Scheduled run","outputField":"payload","timeZone":"","persistDynamic":false,"commandResponseMsgOutput":"output1","outputs":1,"options":[{"name":"schedule1","topic":"topic1","payloadType":"default","payload":"","expressionType":"cron","expression":"0  0  1  1  *  ","location":"","offset":"0","solarType":"all","solarEvents":"sunrise,sunset"}],"x":240,"y":160,"wires":[["45577688ac957f99"]]},{"id":"03cb13cd415ca430","type":"inject","z":"8b14b3c953574b40","g":"ca8ecf0bcc98d479","name":"Kør een gang \\n efter hvert nyt deploy","props":[],"repeat":"","crontab":"","once":true,"onceDelay":"7","topic":"","x":260,"y":100,"wires":[["7e95b253cad342a4"]]},{"id":"7e95b253cad342a4","type":"switch","z":"8b14b3c953574b40","g":"ca8ecf0bcc98d479","name":"Tjek om der køres \\n i udviklermiljø","property":"DEV_ENVIROMENT","propertyType":"env","rules":[{"t":"eq","v":"false","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":490,"y":100,"wires":[["6ce841fbce39163d"]]},{"id":"6ce841fbce39163d","type":"change","z":"8b14b3c953574b40","g":"d7a0dc9f17f84cd2","name":"Konfigurer tabelnavn","rules":[{"t":"set","p":"tablename","pt":"flow","to":"eds_FORBRUG","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":740,"y":120,"wires":[["1582f6ecc6731fd7"]]},{"id":"1582f6ecc6731fd7","type":"template","z":"8b14b3c953574b40","g":"d7a0dc9f17f84cd2","name":"Forespørgsel ↓\\n Opret tabel hvis der ikke \\n eksisterer en i forvejen ","field":"topic","fieldType":"msg","format":"sql","syntax":"mustache","template":"CREATE TABLE if not exists {{flow.tablename}} (\n\tcreated TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\n\tlast_updated TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n\tMonth DATE,\n\tIndustrycode_DE35 VARCHAR(10),\n\tTotalConsumption INT,\n\tUNIQUE (Month, Industrycode_DE35)\n\t);","output":"str","x":990,"y":120,"wires":[["43d0cf92514303e7"]]},{"id":"921fba1309b4cc59","type":"subflow:5f815c7f5707ec58","z":"8b14b3c953574b40","g":"e927759a0e35212b","name":"Send forespørgsel \\n til database","x":550,"y":320,"wires":[["3dbcb455c679d5cd"]]},{"id":"8325eda0730fbb71","type":"subflow:5f815c7f5707ec58","z":"8b14b3c953574b40","g":"558021ee7e67a81d","name":"Send forespørgsel \\n til database","x":510,"y":760,"wires":[["69dbd2a0eb7ccecd"]]},{"id":"b747aa1f23624263","type":"debug","z":"8571dcc8e1e9c903","name":"stdout","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"{\t   \"endpoint\" : baseurl,\t   \"http-response-code\" : statusCode,\t   \"status\" : \"datapull complete\",\t   \"returned-rows\" : payload.total\t}","targetType":"jsonata","statusVal":"","statusType":"auto","x":1040,"y":460,"wires":[]},{"id":"e787251a67b6e815","type":"debug","z":"8571dcc8e1e9c903","name":"stdout","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"{\t   $flowContext(\"tablename\") : \"data insert complete\",\t   \"inserted-rows\" : $count(payload)\t}","targetType":"jsonata","statusVal":"","statusType":"auto","x":780,"y":760,"wires":[]},{"id":"8f35b8f426ac7542","type":"change","z":"8571dcc8e1e9c903","g":"6aa95c95913a1dc8","name":"Konfigurer tabelnavn","rules":[{"t":"set","p":"tablename","pt":"flow","to":"eds_PRODUKTION","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":740,"y":120,"wires":[["5b1c780ffe35c1eb"]]},{"id":"cabaa0127db8b20a","type":"template","z":"8571dcc8e1e9c903","g":"0b6a3796775ca5e9","name":"Forespørgsel ↓\\n Hent dato for seneste række ","field":"topic","fieldType":"msg","format":"sql","syntax":"mustache","template":"SELECT MAX(Month) as latest_month\nFROM {{flow.tablename}}","output":"str","x":260,"y":320,"wires":[["8899c8d86911d51f"]]},{"id":"4cfca818d34a77d6","type":"switch","z":"8571dcc8e1e9c903","g":"0b6a3796775ca5e9","name":"Undersøg dato for \\n seneste række","property":"payload[0].latest_month","propertyType":"msg","rules":[{"t":"null"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":790,"y":320,"wires":[["aec106ee16324493"],["627b9982c16502f9"]]},{"id":"aec106ee16324493","type":"change","z":"8571dcc8e1e9c903","g":"0b6a3796775ca5e9","name":"Hvis NULL sæt startdato to 2018","rules":[{"t":"set","p":"startdato","pt":"msg","to":"2018-01-01","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1110,"y":280,"wires":[["698ef7d845c45259"]]},{"id":"627b9982c16502f9","type":"change","z":"8571dcc8e1e9c903","g":"0b6a3796775ca5e9","name":"Fjern tidsstempel \\n og sæt startdato til dato-streng \\n for seneste række hentet","rules":[{"t":"set","p":"startdato","pt":"msg","to":"$substring($string(payload[0].latest_month), 1, 10)","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":1110,"y":340,"wires":[["698ef7d845c45259","c2b106e1920fee09"]],"info":"Henter den fulde dato og tid fra den seneste række i databasen, konverterer til en teksstren og fjerner tidsstemplet.\nReturnerer derefter den rensede dato"},{"id":"1ae4294ce24de36c","type":"change","z":"8571dcc8e1e9c903","g":"aba12498e68c82c2","name":"Opsætning af forespørgsel ↓ \\n Elforbrug total i kwh pr. måned","rules":[{"t":"set","p":"baseurl","pt":"msg","to":"https://api.energidataservice.dk/dataset/CommunityProduction","tot":"str"},{"t":"set","p":"method","pt":"msg","to":"GET","tot":"str"},{"t":"set","p":"url","pt":"msg","to":"baseurl & \"?offset=0&start=\"&startdato&\"&end=now&filter=%7B%22MunicipalityNo%22:[%22730%22]%7D&sort=Month%20DESC&timezone=dk&limit=10000\"","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":500,"wires":[["f934320bfabf4b28"]],"info":"Based on url query:\n\nhttps://api.energidataservice.dk/dataset/ConsumptionpermunicipalityDE35?offset=0&start=2013-01-01T00:00&end=2023-03-01T00:00&filter=%7B%22MunicipalityNo%22:[%22730%22]%7D&sort=Month%20DESC&timezone=dk"},{"id":"f934320bfabf4b28","type":"http request","z":"8571dcc8e1e9c903","g":"aba12498e68c82c2","name":"Send forespørgsel","method":"use","ret":"obj","paytoqs":"ignore","url":"","tls":"5c13e4731fd7f4cf","persist":false,"proxy":"","insecureHTTPParser":false,"authType":"","senderr":false,"headers":[],"x":550,"y":500,"wires":[["ba6de20626a2f922","12af887fa3e97f37"]]},{"id":"ba6de20626a2f922","type":"change","z":"8571dcc8e1e9c903","g":"aba12498e68c82c2","name":"Oprydning i uaktuelle parametre","rules":[{"t":"delete","p":"url","pt":"msg"},{"t":"delete","p":"method","pt":"msg"},{"t":"delete","p":"headers","pt":"msg"},{"t":"delete","p":"cronplus","pt":"msg"},{"t":"delete","p":"topic","pt":"msg"},{"t":"delete","p":"responseUrl","pt":"msg"},{"t":"delete","p":"manualTrigger","pt":"msg"},{"t":"delete","p":"scheduledEvent","pt":"msg"},{"t":"delete","p":"redirectList","pt":"msg"},{"t":"delete","p":"statusCode","pt":"msg"},{"t":"delete","p":"sort","pt":"msg"},{"t":"delete","p":"object","pt":"msg"},{"t":"set","p":"payload","pt":"msg","to":"payload.records","tot":"msg","dc":true}],"action":"","property":"","from":"","to":"","reg":false,"x":810,"y":500,"wires":[["6a2a56ca0f18b384"]]},{"id":"bae7dd126b39e4a3","type":"change","z":"8571dcc8e1e9c903","g":"c48edeb2197fb965","name":"Skab dataobjekt og \\n fjern overflødige datafelter","rules":[{"t":"set","p":"data","pt":"msg","to":"{\t   \"Month\" : payload.Month,\t   \"Onshore_Windpower_MWh\": payload.OnshoreWindPower,\t   \"Solar_Power_MVh\": payload.SolarPower\t}\t","tot":"jsonata"},{"t":"delete","p":"payload","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":470,"y":620,"wires":[["fc9b6e0147d4efe1"]]},{"id":"9b3dab7dd179293a","type":"split","z":"8571dcc8e1e9c903","g":"c48edeb2197fb965","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":true,"addname":"","x":190,"y":620,"wires":[["bae7dd126b39e4a3"]]},{"id":"85f69593f6d7665e","type":"template","z":"8571dcc8e1e9c903","g":"61c8622d890b37d9","name":"Forespørgsel ↓\\n Indsæt eller opdater \\n data i tabel","field":"topic","fieldType":"msg","format":"sql","syntax":"mustache","template":"INSERT INTO {{flow.tablename}} \n    (Month,\tOnshore_Windpower_MWh,Solar_Power_MVh)\nVALUES( \n        '{{{data.Month}}}',\n        '{{{data.Onshore_Windpower_MWh}}}',\n        '{{data.Solar_Power_MVh}}'\n      )\nON DUPLICATE KEY UPDATE\n    Onshore_Windpower_MWh = '{{{data.Onshore_Windpower_MWh}}}',\n    Solar_Power_MVh = '{{data.Solar_Power_MVh}}'","output":"str","x":240,"y":760,"wires":[["37c93df8cc9511ca"]]},{"id":"37c93df8cc9511ca","type":"delay","z":"8571dcc8e1e9c903","g":"61c8622d890b37d9","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"650","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":375,"y":760,"wires":[["b876a7ae4aa0d502"]],"l":false},{"id":"273cf4f3b5ad8b9d","type":"join","z":"8571dcc8e1e9c903","g":"61c8622d890b37d9","name":"","mode":"auto","build":"object","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":true,"timeout":"","count":"","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":655,"y":760,"wires":[["e787251a67b6e815"]],"l":false},{"id":"5b1c780ffe35c1eb","type":"template","z":"8571dcc8e1e9c903","g":"6aa95c95913a1dc8","name":"Forespørgsel ↓\\n Opret tabel hvis der ikke \\n eksisterer en i forvejen ","field":"topic","fieldType":"msg","format":"sql","syntax":"mustache","template":"CREATE TABLE if not exists {{flow.tablename}} (\n\tcreated TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\n\tlast_updated TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n\tMonth DATE,\n\tOnshore_Windpower_MWh DECIMAL(10,2),\n\tSolar_Power_MVh DECIMAL(10,2),\n\tUNIQUE (Month, Onshore_Windpower_MWh, Solar_Power_MVh)\n\t);","output":"str","x":990,"y":120,"wires":[["4be122699e16f822"]]},{"id":"00864b74fec3e5b7","type":"debug","z":"8571dcc8e1e9c903","name":"stdout","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"payload.warningStatus = 0\t? { $flowContext(\"tablename\"): \"table created\" }:\tpayload.warningStatus = 1\t? { $flowContext(\"tablename\"): \"table exists\" }:\t{\"warningstatus\" : payload.warningStatus}","targetType":"jsonata","statusVal":"","statusType":"auto","x":1420,"y":120,"wires":[]},{"id":"4be122699e16f822","type":"subflow:5f815c7f5707ec58","z":"8571dcc8e1e9c903","g":"6aa95c95913a1dc8","name":"Send forespørgsel \\n til database","x":1210,"y":120,"wires":[["00864b74fec3e5b7","ec2cbaa5abdb2dc0"]]},{"id":"5c265e4ca4ab11ea","type":"cronplus","z":"8571dcc8e1e9c903","g":"616fd052c81e52cc","name":"Scheduled run","outputField":"payload","timeZone":"","persistDynamic":false,"commandResponseMsgOutput":"output1","outputs":1,"options":[{"name":"schedule1","topic":"topic1","payloadType":"default","payload":"","expressionType":"cron","expression":"0  0  1  1  *  ","location":"","offset":"0","solarType":"all","solarEvents":"sunrise,sunset"}],"x":240,"y":160,"wires":[["ac5e094c99a67b2d"]]},{"id":"1e0bb0ba8b707c57","type":"inject","z":"8571dcc8e1e9c903","g":"616fd052c81e52cc","name":"Kør een gang \\n efter hvert nyt deploy","props":[],"repeat":"","crontab":"","once":true,"onceDelay":"7","topic":"","x":260,"y":100,"wires":[["59b47841deed3db1"]]},{"id":"59b47841deed3db1","type":"switch","z":"8571dcc8e1e9c903","g":"616fd052c81e52cc","name":"Tjek om der køres \\n i udviklermiljø","property":"DEV_ENVIROMENT","propertyType":"env","rules":[{"t":"eq","v":"false","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":490,"y":100,"wires":[["8f35b8f426ac7542"]]},{"id":"8899c8d86911d51f","type":"subflow:5f815c7f5707ec58","z":"8571dcc8e1e9c903","g":"0b6a3796775ca5e9","name":"Send forespørgsel \\n til database","x":550,"y":320,"wires":[["4cfca818d34a77d6"]]},{"id":"b876a7ae4aa0d502","type":"subflow:5f815c7f5707ec58","z":"8571dcc8e1e9c903","g":"61c8622d890b37d9","name":"Send forespørgsel \\n til database","x":510,"y":760,"wires":[["273cf4f3b5ad8b9d"]]},{"id":"c2b106e1920fee09","type":"debug","z":"8571dcc8e1e9c903","name":"debug 29","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1280,"y":540,"wires":[]}]